from flask import render_template, request, redirect, url_for, Flask
import base64
from conexao import get_db_connection

app = Flask(__name__, static_url_path='/static')

@app.route('/login')
def login():
  user = request.args.get('user')
  password = request.args.get('password')
  if user == 'admin' and password == 'admin':
    return redirect(url_for('inicioa'))
  elif user is not None and password is not None:
    return redirect(url_for('inicio'))
  else:
    return render_template('login.html')

@app.route('/inicio')
def inicio():
  conn = get_db_connection()
  if conn is not None:
      info = conn.execute('SELECT * FROM categoria').fetchall()
      return render_template('iniciouser.html',info=info)
  else:
    return "Error: N達o conseguiu conectar ao database"

@app.route('/contato')
def contato_user():
  conn = get_db_connection()
  info = conn.execute('SELECT * FROM categoria').fetchall()
  return render_template('contatouser.html', info=info)

@app.route('/sobre')
def sobre_user():
  conn = get_db_connection()
  info = conn.execute('SELECT * FROM categoria').fetchall()
  return render_template('sobreuser.html', info=info)
    
@app.route('/inicio/admin')
def inicioa():
  conn = get_db_connection()
  if conn is not None:
      categorias = conn.execute('SELECT * FROM museu').fetchall()
      info = conn.execute('SELECT * FROM categoria').fetchall()
      return render_template('inicio.html', categorias=categorias, info=info)
  else:
    return "ERROR: N達o conseguiu conectar ao database"

@app.route('/contato/admin')
def contato():
  conn = get_db_connection()
  info = conn.execute('SELECT * FROM categoria').fetchall()
  return render_template('contato.html', info=info)
  
@app.route('/sobre/admin')
def sobre():
  conn = get_db_connection()
  info = conn.execute('SELECT * FROM categoria').fetchall()
  return render_template('sobre.html', info=info)
  
@app.route('/inserir/admin', methods=['GET', 'POST'])
def inserir():
  conn = get_db_connection()
  info=conn.execute('SELECT * FROM categoria')
  if request.method == 'POST':
      nome = request.form.get('nome')
      descricao = request.form.get('descricao')
      imagem = request.files.get('img')
      id_cat = request.form.get('id_cat')

      if imagem:
        imagem_base64 = base64.b64encode(imagem.read()).decode('utf-8')


        conn.execute(
            'INSERT INTO museu(nome, descricao, img, id_categoria) values (?, ?, ?, ?)',
            (nome, descricao, imagem_base64, id_cat)
        )
        conn.commit()
        conn.close()
        return redirect(url_for('inicioa'))

  return render_template('inserir.html', info=info)
  
@app.route('/excluir/admin', methods=['GET', 'POST'])
def excluir():
  id = request.form.get('id')
  conn = get_db_connection()
  categorias = conn.execute('SELECT * FROM museu').fetchall()
  if request.method == 'POST':
      conn.execute('DELETE FROM museu WHERE id = ?', (id,))
      conn.commit()
      conn.close()
      return redirect(url_for('inicioa'))
  return render_template('excluir.html', categorias=categorias)

@app.route('/inicio_cat/<int:id>')
def inicio_cat(id):
    conn = get_db_connection()
    if conn is not None:
        categoria = conn.execute('SELECT * FROM categoria WHERE id = ?', (id,)).fetchone()
        if categoria:
            produtos = conn.execute('SELECT * FROM museu WHERE id_categoria = ?', (id,)).fetchall()
            categorias = conn.execute('SELECT * FROM categoria').fetchall()
            conn.close()
            return render_template('processadores.html', categoria=categoria, produtos=produtos, categorias=categorias)
        else:
            conn.close()
            return "Categoria n達o encontrada."
    else:
        return "Erro ao conectar ao banco de dados."
    
@app.route('/inicio_cat_user/<int:id>')
def inicio_cat_user(id):
    conn = get_db_connection()
    if conn is not None:
        info = conn.execute('SELECT * FROM categoria').fetchall()
        categoria = conn.execute('SELECT * FROM categoria WHERE id = ?', (id,)).fetchone()
        if categoria:
            produtos = conn.execute('SELECT * FROM museu WHERE id_categoria = ?', (id,)).fetchall()
            conn.close()
            return render_template('processadoresuse.html', categoria=categoria, produtos=produtos, info=info)
        else:
            conn.close()
            return "Categoria n達o encontrada."
    else:
        return "Erro ao conectar ao banco de dados."
    
@app.route('/inserir_cat/admin', methods=['GET', 'POST'])
def inserir_cat():
  conn = get_db_connection()
  info = conn.execute('SELECT * FROM categoria')
  nome_categoria = request.form.get('nome')
  if nome_categoria and conn.execute(
      'SELECT * FROM categoria WHERE nome_da_categoria = ?', (nome_categoria,)
  ).fetchone() is None:
      conn.execute('INSERT INTO categoria(nome_da_categoria) values (?)', (nome_categoria,))
      conn.commit()
      conn.close()
      return redirect(url_for('inserir'))
  return render_template('inserir_cat.html', info=info)

@app.route('/excluir_cat/admin', methods=['GET', 'POST'])
def excluir_cat():
  id = request.form.get('name')
  conn = get_db_connection()
  categorias = conn.execute('SELECT * FROM categoria').fetchall()
  if request.method == 'POST':
      conn.execute('DELETE FROM categoria WHERE id = ?', (id,))
      conn.commit()
      conn.close()
      return redirect(url_for('inicioa'))
  return render_template('excluir_cat.html', categorias=categorias)
  
if __name__ == '__main__':
  app.run(host='0.0.0.0', port=80)
